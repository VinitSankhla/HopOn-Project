<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HopOn Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üö¥‚Äç‚ôÇÔ∏è</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .header {
            background: white;
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .user-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .user-details {
            display: flex;
            flex-direction: column;
        }
        
        .user-name {
            font-weight: 600;
            color: #333;
        }
        
        .user-rides {
            font-size: 12px;
            color: #666;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        .btn-outline {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
        }
        
        .btn-outline:hover {
            background: #667eea;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        
        .welcome-card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .welcome-title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }
        
        .welcome-subtitle {
            font-size: 16px;
            color: #666;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: between;
            margin-bottom: 20px;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card-icon {
            width: 24px;
            height: 24px;
            background: #667eea;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }
        
        .card-body {
            color: #666;
            line-height: 1.6;
        }
        
        .location-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .location-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .location-name {
            font-weight: 500;
            color: #333;
        }
        
        .bike-count {
            font-size: 12px;
            color: #666;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }
        
        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }
        
        .stat-icon.primary { background: #667eea; }
        .stat-icon.success { background: #28a745; }
        .stat-icon.warning { background: #ffc107; color: #333; }
        .stat-icon.info { background: #17a2b8; }
        
        .stat-info {
            display: flex;
            flex-direction: column;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }
        
        .action-btn {
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            color: #333;
        }
        
        .action-btn:hover {
            background: #e9ecef;
            border-color: #667eea;
            transform: translateY(-2px);
        }
        
        .action-icon {
            display: block;
            font-size: 20px;
            margin-bottom: 8px;
            color: #667eea;
        }
        
        .action-text {
            font-size: 12px;
            font-weight: 500;
        }
        
        .active-ride {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            display: none;
        }
        
        .ride-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .ride-timer {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 18px;
            font-weight: 600;
        }
        
        .no-rides {
            text-align: center;
            padding: 30px;
            color: #666;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: rgba(255,255,255,0.8);
            font-size: 14px;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .close-btn {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .close-btn:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 25px;
        }

        .modal-body p {
            margin: 0 0 20px 0;
            font-size: 16px;
            color: #333;
            text-align: center;
        }

        .location-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .location-btn {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px 15px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .location-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .location-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .location-name {
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }

        .location-desc {
            font-size: 12px;
            color: #666;
        }

        .modal-footer {
            padding: 15px 25px;
            border-top: 1px solid #e9ecef;
            text-align: center;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .location-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .modal-content {
                margin: 15% auto;
                width: 95%;
            }

            .location-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo">
                üö¥‚Äç‚ôÇÔ∏è HopOn
            </div>
            <div class="user-section">
                <div class="user-info">
                    <div class="user-avatar">U</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Loading...</div>
                        <div class="user-rides">üö¥‚Äç‚ôÇÔ∏è <span id="totalRides">0</span> rides</div>
                    </div>
                </div>
                <button class="btn btn-outline" onclick="viewHistory()">üìä History</button>
                <button class="btn btn-secondary" onclick="logout()">üö™ Logout</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Welcome Section -->
        <div class="welcome-card">
            <div class="welcome-title" id="welcomeMessage">Welcome to HopOn!</div>
            <div class="welcome-subtitle">Ready for your next campus adventure?</div>
        </div>

        <!-- Active Ride (Hidden by default) -->
        <div id="activeRide" class="active-ride">
            <div class="ride-header">
                <h3>üö¥‚Äç‚ôÇÔ∏è Current Ride</h3>
                <div class="ride-timer" id="rideTimer">15:00</div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div>Bike: <span id="activeBikeId">BIKE001</span></div>
                    <div>Route: <span id="activeRoute">AB1 ‚Üí AB2</span></div>
                </div>
                <button class="btn btn-primary" onclick="endRide()">üõë End Ride</button>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid">
            <!-- Start Ride Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon">üö¥‚Äç‚ôÇÔ∏è</div>
                        Start New Ride
                    </div>
                </div>
                <div class="card-body">
                    <p>Book a bike and start your journey across campus</p>
                    <div style="margin: 15px 0;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                            <span style="color: #667eea;">üö¥‚Äç‚ôÇÔ∏è</span>
                            <span id="total-available-bikes">Loading...</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="color: #667eea;">‚è∞</span>
                            <span>15 min default timer</span>
                        </div>
                    </div>
                    <button class="btn btn-primary" style="width: 100%; padding: 12px;" id="startRideBtn" onclick="startRide()">
                        üö¥‚Äç‚ôÇÔ∏è Start Ride
                    </button>
                </div>
            </div>

            <!-- Recent Rides Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon">üìä</div>
                        Recent Rides
                    </div>
                </div>
                <div class="card-body">
                    <div id="recentRides">
                        <div class="no-rides">
                            <div style="font-size: 40px; margin-bottom: 10px;">üö¥</div>
                            <p>No rides yet. Start your first HopOn adventure!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Campus Locations Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon">üìç</div>
                        Campus Locations
                    </div>
                </div>
                <div class="card-body">
                    <div class="location-grid">
                        <div class="location-item">
                            <div class="location-name">üè¢ AB1</div>
                            <div class="bike-count" id="ab1-bikes">25 bikes</div>
                        </div>
                        <div class="location-item">
                            <div class="location-name">üè¢ AB2</div>
                            <div class="bike-count" id="ab2-bikes">0 bikes</div>
                        </div>
                        <div class="location-item">
                            <div class="location-name">üè† Boys Hostel</div>
                            <div class="bike-count" id="boys-hostel-bikes">0 bikes</div>
                        </div>
                        <div class="location-item">
                            <div class="location-name">üè† Girls Hostel</div>
                            <div class="bike-count" id="girls-hostel-bikes">0 bikes</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <div class="card-icon">‚ö°</div>
                        Quick Actions
                    </div>
                </div>
                <div class="card-body">
                    <div class="action-buttons">
                        <div class="action-btn" onclick="startRide()">
                            <div class="action-icon">üö¥‚Äç‚ôÇÔ∏è</div>
                            <div class="action-text">Book Ride</div>
                        </div>
                        <div class="action-btn" onclick="viewHistory()">
                            <div class="action-icon">üìä</div>
                            <div class="action-text">View History</div>
                        </div>
                        <div class="action-btn" onclick="refreshData()">
                            <div class="action-icon">üîÑ</div>
                            <div class="action-text">Refresh</div>
                        </div>
                        <div class="action-btn" onclick="showHelp()">
                            <div class="action-icon">‚ùì</div>
                            <div class="action-text">Help</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Section -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon success">üö¥‚Äç‚ôÇÔ∏è</div>
                <div class="stat-info">
                    <div class="stat-number" id="totalRidesDisplay">0</div>
                    <div class="stat-label">Total Rides</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon primary">‚è∞</div>
                <div class="stat-info">
                    <div class="stat-number" id="totalTimeDisplay">0h</div>
                    <div class="stat-label">Total Time</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon warning">üìç</div>
                <div class="stat-info">
                    <div class="stat-number" id="favLocationDisplay">AB1</div>
                    <div class="stat-label">Favorite Start</div>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon info">üìÖ</div>
                <div class="stat-info">
                    <div class="stat-number" id="joinDateDisplay">Today</div>
                    <div class="stat-label">Member Since</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        &copy; 2025 HopOn. Making campus mobility effortless.
    </div>

    <!-- End Ride Modal -->
    <div id="endRideModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üõë End Your Ride</h3>
                <span class="close-btn" onclick="closeEndRideModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>Where are you parking the bike?</p>
                <div class="location-options">
                    <button class="location-btn" onclick="selectEndLocation('AB1')">
                        <div class="location-icon">üè¢</div>
                        <div class="location-name">AB1</div>
                        <div class="location-desc">Academic Block 1</div>
                    </button>
                    <button class="location-btn" onclick="selectEndLocation('AB2')">
                        <div class="location-icon">üè¢</div>
                        <div class="location-name">AB2</div>
                        <div class="location-desc">Academic Block 2</div>
                    </button>
                    <button class="location-btn" onclick="selectEndLocation('BOYS HOSTEL')">
                        <div class="location-icon">üè†</div>
                        <div class="location-name">Boys Hostel</div>
                        <div class="location-desc">Residential Area</div>
                    </button>
                    <button class="location-btn" onclick="selectEndLocation('GIRLS HOSTEL')">
                        <div class="location-icon">üè†</div>
                        <div class="location-name">Girls Hostel</div>
                        <div class="location-desc">Residential Area</div>
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeEndRideModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- JavaScript Files -->
    <script src="../js/api.js"></script>
    <script src="../js/storage.js"></script>
    <script>
        // Dashboard initialization with API integration
        async function initializeDashboard() {
            console.log('üìä Dashboard initializing...');

            try {
                // Check authentication
                const user = await storage.getCurrentUser();
                if (!user) {
                    alert('Please login to access dashboard.');
                    window.location.href = '../login.html';
                    return;
                }

                console.log('User authenticated:', user.name);

                // Update user info
                await updateUserInfo(user);
                await updateUserStats(user);
                await updateRecentRides(user);
                await updateBikeStats();
                await updateLocationBikeCounts();
                await checkActiveRide(user);

                console.log('‚úÖ Dashboard initialized successfully');

                // Start periodic updates for bike counts (every 30 seconds)
                startPeriodicUpdates();
            } catch (error) {
                console.error('‚ùå Dashboard initialization failed:', error);
                showError('Failed to load dashboard. Please refresh the page.');
            }
        }

        // Start periodic updates for real-time data
        function startPeriodicUpdates() {
            // Update bike counts every 30 seconds
            window.bikeCountInterval = setInterval(async () => {
                try {
                    await updateLocationBikeCounts();
                    console.log('üîÑ Bike counts updated automatically');
                } catch (error) {
                    console.error('Error in periodic bike count update:', error);
                }
            }, 30000); // 30 seconds

            // Update user stats every 2 minutes
            window.statsInterval = setInterval(async () => {
                try {
                    const user = await storage.getCurrentUser();
                    if (user) {
                        await updateUserStats(user);
                        await updateRecentRides(user);
                        await updateBikeStats();
                        console.log('üìä User stats updated automatically');
                    }
                } catch (error) {
                    console.error('Error in periodic stats update:', error);
                }
            }, 120000); // 2 minutes
        }

        // Stop periodic updates (cleanup)
        function stopPeriodicUpdates() {
            if (window.bikeCountInterval) {
                clearInterval(window.bikeCountInterval);
                window.bikeCountInterval = null;
            }
            if (window.statsInterval) {
                clearInterval(window.statsInterval);
                window.statsInterval = null;
            }
        }

        // Stop updates when user leaves the page
        window.addEventListener('beforeunload', stopPeriodicUpdates);

        // Add keyboard support for modal
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('endRideModal');
                if (modal && modal.style.display === 'block') {
                    closeEndRideModal();
                }
            }
        });

        // Update user information display
        async function updateUserInfo(user) {
            document.getElementById('userName').textContent = user.name;

            // Update user avatar with first letter
            const userAvatar = document.querySelector('.user-avatar');
            if (userAvatar && user.name) {
                userAvatar.textContent = user.name.charAt(0).toUpperCase();
            }
        }

        // Update user statistics
        async function updateUserStats(user) {
            try {
                const rides = await storage.getUserRides(user.id);
                const completedRides = rides.filter(ride => ride.status === 'completed');

                // Update rides count
                document.getElementById('totalRides').textContent = completedRides.length;
                document.getElementById('totalRidesDisplay').textContent = completedRides.length;

                // Calculate total time from all completed rides
                let totalMinutes = 0;
                completedRides.forEach(ride => {
                    totalMinutes += ride.timerDuration || 15;
                });

                // Convert to hours and minutes for display
                const totalHours = Math.floor(totalMinutes / 60);
                const remainingMinutes = totalMinutes % 60;

                // Update total time display
                const totalTimeEl = document.getElementById('totalTimeDisplay');
                if (totalTimeEl) {
                    if (totalHours > 0) {
                        totalTimeEl.textContent = `${totalHours}h ${remainingMinutes}m`;
                    } else {
                        totalTimeEl.textContent = `${remainingMinutes}m`;
                    }
                }

                // Calculate favorite location
                const locationCount = {};
                completedRides.forEach(ride => {
                    const startLocation = ride.startLocation;
                    if (startLocation) {
                        locationCount[startLocation] = (locationCount[startLocation] || 0) + 1;
                    }
                });

                let favoriteLocation = 'Not yet';
                let maxCount = 0;
                for (const location in locationCount) {
                    if (locationCount[location] > maxCount) {
                        maxCount = locationCount[location];
                        favoriteLocation = location;
                    }
                }

                const favLocationEl = document.getElementById('favoriteLocationDisplay');
                if (favLocationEl) {
                    favLocationEl.textContent = favoriteLocation;
                }
            } catch (error) {
                console.error('Error updating user stats:', error);
            }
        }

        // Update bike statistics
        async function updateBikeStats() {
            try {
                const stats = await storage.getStats();

                // Update available bikes count
                const availableBikesEl = document.getElementById('availableBikes');
                if (availableBikesEl && stats) {
                    availableBikesEl.textContent = stats.totalBikes - stats.activeRides || 25;
                }

                // Update total system bikes
                const totalBikesEl = document.getElementById('totalBikesSystem');
                if (totalBikesEl && stats) {
                    totalBikesEl.textContent = stats.totalBikes || 25;
                }
            } catch (error) {
                console.error('Error updating bike stats:', error);
                // Fallback values
                const availableBikesEl = document.getElementById('availableBikes');
                if (availableBikesEl) availableBikesEl.textContent = '25';
            }
        }

        // Update recent rides display
        async function updateRecentRides(user) {
            try {
                const rides = await storage.getUserRides(user.id);
                const completedRides = rides.filter(ride => ride.status === 'completed')
                    .sort((a, b) => new Date(b.endTime) - new Date(a.endTime))
                    .slice(0, 2); // Get last 2 rides

                const recentRidesContainer = document.getElementById('recentRides');
                if (!recentRidesContainer) return;

                if (completedRides.length === 0) {
                    recentRidesContainer.innerHTML = `
                        <div class="no-rides">
                            <div style="font-size: 40px; margin-bottom: 10px;">üö¥</div>
                            <p>No rides yet. Start your first HopOn adventure!</p>
                        </div>
                    `;
                    return;
                }

                // Create HTML for recent rides
                let ridesHtml = '';
                completedRides.forEach(ride => {
                    const startTime = new Date(ride.startTime);
                    const endTime = new Date(ride.endTime);
                    const duration = ride.timerDuration || Math.round((endTime - startTime) / (1000 * 60));
                    const timeAgo = getTimeAgo(endTime);

                    ridesHtml += `
                        <div style="padding: 12px; margin-bottom: 10px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #333; margin-bottom: 4px;">
                                        üö¥‚Äç‚ôÇÔ∏è ${ride.startLocation} ‚Üí ${ride.endLocation}
                                    </div>
                                    <div style="font-size: 12px; color: #666;">
                                        <span style="margin-right: 12px;">‚è±Ô∏è ${duration}min</span>
                                        <span style="margin-right: 12px;">üö≤ ${ride.bikeId}</span>
                                    </div>
                                </div>
                                <div style="font-size: 11px; color: #888; text-align: right;">
                                    ${timeAgo}
                                </div>
                            </div>
                            ${ride.rating ? `
                                <div style="font-size: 12px; color: #667eea;">
                                    ${'‚≠ê'.repeat(ride.rating)} ${ride.rating}/5
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                recentRidesContainer.innerHTML = ridesHtml;

            } catch (error) {
                console.error('Error updating recent rides:', error);
                const recentRidesContainer = document.getElementById('recentRides');
                if (recentRidesContainer) {
                    recentRidesContainer.innerHTML = `
                        <div class="no-rides">
                            <div style="font-size: 40px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                            <p>Unable to load recent rides.</p>
                        </div>
                    `;
                }
            }
        }

        // Update location bike counts
        async function updateLocationBikeCounts() {
            const locations = ['AB1', 'AB2', 'BOYS HOSTEL', 'GIRLS HOSTEL'];
            const locationIds = ['ab1-bikes', 'ab2-bikes', 'boys-hostel-bikes', 'girls-hostel-bikes'];

            try {
                // Get bike counts for each location
                for (let i = 0; i < locations.length; i++) {
                    const location = locations[i];
                    const elementId = locationIds[i];

                    try {
                        const response = await storage.getAvailableBikes(location);
                        const bikeCount = Array.isArray(response) ? response.length : 0;

                        const element = document.getElementById(elementId);
                        if (element) {
                            element.textContent = `${bikeCount} bikes`;
                        }
                    } catch (locationError) {
                        console.error(`Error getting bikes for ${location}:`, locationError);
                        // Keep existing content or set to 0 if element exists
                        const element = document.getElementById(elementId);
                        if (element && element.textContent.includes('25 bikes') && location !== 'AB1') {
                            element.textContent = '0 bikes';
                        }
                    }
                }

                // Also update the main "available bikes" count in the Start Ride card
                const totalStats = await storage.getStats();
                const totalAvailable = totalStats.totalBikes - totalStats.activeRides;
                const startRideAvailableEl = document.getElementById('total-available-bikes');
                if (startRideAvailableEl) {
                    startRideAvailableEl.textContent = `${totalAvailable} Bikes Available`;
                }

            } catch (error) {
                console.error('Error updating location bike counts:', error);
            }
        }

        // Check for active ride
        async function checkActiveRide(user) {
            try {
                const activeRide = await storage.getActiveRide(user.id);

                if (activeRide) {
                    console.log('üö¥‚Äç‚ôÇÔ∏è Active ride found:', activeRide);
                    showActiveRideSection(activeRide);
                } else {
                    console.log('No active ride');
                    hideActiveRideSection();
                }
            } catch (error) {
                console.error('Error checking active ride:', error);
                hideActiveRideSection();
            }
        }

        // Show active ride section
        function showActiveRideSection(ride) {
            const activeRideSection = document.getElementById('activeRide');
            const startRideBtn = document.getElementById('startRideBtn');

            if (activeRideSection) {
                activeRideSection.style.display = 'block';

                // Update ride details
                const bikeIdEl = document.getElementById('activeBikeId');
                const routeEl = document.getElementById('activeRoute');

                if (bikeIdEl) bikeIdEl.textContent = ride.bikeId;
                if (routeEl) {
                    routeEl.innerHTML = `${ride.startLocation} ‚Üí ${ride.endLocation}`;
                }

                // Start timer
                startRideTimer(ride);
            }

            if (startRideBtn) {
                startRideBtn.style.display = 'none';
            }
        }

        // Hide active ride section
        function hideActiveRideSection() {
            const activeRideSection = document.getElementById('activeRide');
            const startRideBtn = document.getElementById('startRideBtn');

            if (activeRideSection) {
                activeRideSection.style.display = 'none';
            }

            if (startRideBtn) {
                startRideBtn.style.display = 'block';
            }
        }

        // Start ride timer
        function startRideTimer(ride) {
            if (window.rideTimer) clearInterval(window.rideTimer);

            const startTime = new Date(ride.startTime);
            const timerDuration = ride.timerDuration * 60 * 1000; // Convert to milliseconds

            window.rideTimer = setInterval(() => {
                const now = new Date();
                const elapsed = now - startTime;
                const remaining = Math.max(0, timerDuration - elapsed);

                const minutes = Math.floor(remaining / (1000 * 60));
                const seconds = Math.floor((remaining % (1000 * 60)) / 1000);

                const timerEl = document.getElementById('rideTimer');
                if (timerEl) {
                    const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    timerEl.textContent = timeString;

                    // Change color when time is running low
                    if (remaining < 2 * 60 * 1000) {
                        timerEl.classList.add('warning');
                    } else if (remaining < 5 * 60 * 1000) {
                        timerEl.classList.add('caution');
                    }
                }

                // Auto-end ride when timer expires
                if (remaining <= 0) {
                    autoEndRide(ride);
                }
            }, 1000);
        }

        // Auto-end ride
        async function autoEndRide(ride) {
            if (window.rideTimer) {
                clearInterval(window.rideTimer);
                window.rideTimer = null;
            }

            try {
                await storage.completeRide(ride.id, ride.endLocation, null, 'Timer expired');
                showMessage('Your ride has ended automatically due to timer expiry!', 'warning');

                // Refresh dashboard
                const user = await storage.getCurrentUser();
                await checkActiveRide(user);
                await updateUserStats(user);
                await updateRecentRides(user);
                await updateLocationBikeCounts();
            } catch (error) {
                console.error('Error auto-ending ride:', error);
                showMessage('Error ending ride automatically. Please end manually.', 'error');
            }
        }

        // Utility functions
        function showMessage(message, type = 'info') {
            const messageEl = document.createElement('div');
            messageEl.className = `alert alert-${type}`;
            messageEl.textContent = message;

            document.body.appendChild(messageEl);

            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.parentNode.removeChild(messageEl);
                }
            }, 5000);
        }

        function showError(message) {
            showMessage(message, 'error');
        }

        // Event handlers
        function showHelp() {
            alert('‚ùì Help & Support\n\nüìß Email: vssankhla2006@gmail.com\nFill out the form for complaints and suggestions\nhttps://forms.gle/sM2SxSZFX8cLiGAw9');
        }

        async function logout() {
            try {
                storage.logout();
                showMessage('Logged out successfully!', 'success');
                setTimeout(() => {
                    window.location.href = '../login.html';
                }, 1000);
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '../login.html';
            }
        }

        async function endRide() {
            console.log('üõë endRide function called');

            try {
                const user = await storage.getCurrentUser();
                console.log('üë§ Current user in endRide:', user);

                if (!user) {
                    console.error('‚ùå No user found in endRide');
                    showMessage('Please login to end ride.', 'error');
                    return;
                }

                const activeRide = await storage.getActiveRide(user.id);
                console.log('üö¥‚Äç‚ôÇÔ∏è Active ride found:', activeRide);

                if (!activeRide) {
                    console.warn('‚ö†Ô∏è No active ride found for user:', user.id);
                    showMessage('No active ride found.', 'warning');
                    return;
                }

                // Store the active ride for use in modal
                window.currentActiveRide = activeRide;
                console.log('üíæ Stored activeRide in window.currentActiveRide:', window.currentActiveRide);

                // Show the location selection modal
                showEndRideModal();

            } catch (error) {
                console.error('‚ùå Error in endRide function:', error);
                showMessage('Error loading ride data. Please try again.', 'error');
            }
        }

        // Modal functions for end ride
        function showEndRideModal() {
            const modal = document.getElementById('endRideModal');
            if (modal) {
                modal.style.display = 'block';
                // Add event listener for clicking outside modal
                modal.onclick = function(event) {
                    if (event.target === modal) {
                        closeEndRideModal();
                    }
                };
            }
        }

        function closeEndRideModal() {
            const modal = document.getElementById('endRideModal');
            if (modal) {
                modal.style.display = 'none';
                modal.onclick = null;
                window.currentActiveRide = null;
            }
        }

        async function selectEndLocation(location) {
            console.log('üõë selectEndLocation called with location:', location);
            console.log('üõë currentActiveRide:', window.currentActiveRide);

            if (!window.currentActiveRide) {
                console.error('‚ùå No active ride found in window.currentActiveRide');
                showMessage('No active ride found.', 'error');
                closeEndRideModal();
                return;
            }

            try {
                // Show loading message first
                showMessage('Ending ride...', 'info');
                console.log('üîÑ Starting ride completion process...');

                // Get current user
                const user = await storage.getCurrentUser();
                console.log('üë§ Current user:', user);

                if (!user) {
                    throw new Error('User not authenticated');
                }

                // Test API connectivity first
                try {
                    const healthCheck = await api.healthCheck();
                    console.log('üè• API health check:', healthCheck);
                } catch (healthError) {
                    console.warn('‚ö†Ô∏è API health check failed:', healthError);
                }

                // Complete the ride with detailed logging
                console.log('üö¥‚Äç‚ôÇÔ∏è Calling completeRide with:', {
                    rideId: window.currentActiveRide.id,
                    endLocation: location,
                    userId: user.id
                });

                const result = await storage.completeRide(window.currentActiveRide.id, location);
                console.log('‚úÖ completeRide result:', result);

                // Check if result indicates failure
                if (result && result.success === false) {
                    throw new Error(result.message || 'Failed to complete ride');
                }

                // If result is undefined or doesn't have success property, try to validate
                if (!result || (result.success !== true && result.success !== false)) {
                    console.warn('‚ö†Ô∏è Unexpected result format:', result);
                    // Don't throw error, assume success if no explicit failure
                }

                // Verify the ride was actually completed
                console.log('üîç Verifying ride completion...');
                const verifyActiveRide = await storage.getActiveRide(user.id);
                console.log('üîç Active ride after completion attempt:', verifyActiveRide);

                if (verifyActiveRide && verifyActiveRide.id === window.currentActiveRide.id) {
                    // Ride is still active, completion might have failed
                    throw new Error('Ride completion verification failed - ride is still active');
                }

                // Close modal after successful completion
                closeEndRideModal();

                showMessage('Ride completed successfully!', 'success');
                console.log('üéâ Ride completed successfully, refreshing dashboard...');

                // Refresh dashboard immediately since completion is verified
                try {
                    await checkActiveRide(user);
                    await updateUserStats(user);
                    await updateRecentRides(user);
                    await updateBikeStats();
                    await updateLocationBikeCounts();
                    console.log('‚úÖ Dashboard refreshed after ride completion');
                } catch (refreshError) {
                    console.error('‚ùå Error refreshing dashboard:', refreshError);
                    // Still show success since ride was completed
                }

            } catch (error) {
                console.error('‚ùå Error ending ride:', error);
                showMessage(`Failed to end ride: ${error.message}`, 'error');
                // Don't close modal on error so user can try again
            }
        }

        // Helper functions for backward compatibility
        function startRide() {
            window.location.href = 'booking.html';
        }

        function viewHistory() {
            window.location.href = 'history.html';
        }

        async function refreshData() {
            try {
                const user = await storage.getCurrentUser();
                if (user) {
                    await updateUserStats(user);
                    await updateRecentRides(user);
                    await updateBikeStats();
                    await updateLocationBikeCounts();
                    await checkActiveRide(user);
                    showMessage('Data refreshed successfully!', 'success');
                }
            } catch (error) {
                console.error('Error refreshing data:', error);
                showMessage('Failed to refresh data. Reloading page...', 'warning');
                setTimeout(() => window.location.reload(), 2000);
            }
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;

            return date.toLocaleDateString();
        }

        // Initialize dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for API and storage to be available
            if (typeof api !== 'undefined' && typeof storage !== 'undefined') {
                initializeDashboard();
            } else {
                console.warn('API or storage not available, retrying...');
                setTimeout(() => {
                    if (typeof api !== 'undefined' && typeof storage !== 'undefined') {
                        initializeDashboard();
                    } else {
                        showError('Failed to load required services. Please refresh the page.');
                    }
                }, 1000);
            }
        });
    </script>
</body>
</html>